<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Orden de Compra</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .item-row {
            background-color: #f9fafb;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.375rem;
            border: 1px solid #e5e7eb;
        }
        .required-field::after {
            content: ' *';
            color: #ef4444;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="w-64 bg-gray-800 text-white">
            <div class="p-4">
                <div class="flex items-center space-x-2 mb-8">
                    <i class="fas fa-user-circle text-2xl"></i>
                    <span id="userName" class="text-lg">Usuario</span>
                </div>
                <nav>
                    <ul class="space-y-2">
                        <li>
                            <a href="index.html" class="flex items-center space-x-2 p-2 hover:bg-gray-700 rounded">
                                <i class="fas fa-home"></i>
                                <span>Inicio</span>
                            </a>
                        </li>
                        <li>
                            <a href="solicitudes.html" class="flex items-center space-x-2 p-2 hover:bg-gray-700 rounded">
                                <i class="fas fa-file-alt"></i>
                                <span>Solicitudes</span>
                            </a>
                        </li>
                        <li>
                            <a href="ordenes-compra.html" class="flex items-center space-x-2 p-2 bg-blue-600 rounded">
                                <i class="fas fa-shopping-cart"></i>
                                <span>Órdenes de Compra</span>
                            </a>
                        </li>
                        <li>
                            <a href="login.html" class="flex items-center space-x-2 p-2 hover:bg-gray-700 rounded" id="cerrarSesion">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>Cerrar Sesión</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>

        <!-- Contenido principal -->
        <div class="flex-1 overflow-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold text-gray-800">Editar Orden de Compra</h1>
                </div>

                <form id="ordenCompraForm" class="space-y-6">
                    <!-- Información General -->
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="border-b border-gray-200 px-6 py-4">
                            <h2 class="text-lg font-medium text-gray-800">Información General</h2>
                        </div>
                        <div class="px-6 py-4">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <label for="numeroOC" class="block text-sm font-medium text-gray-700 required-field">Número OC</label>
                                    <input type="text" id="numeroOC" readonly class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 bg-gray-100">
                                </div>
                                <div>
                                    <label for="fechaEmision" class="block text-sm font-medium text-gray-700 required-field">Fecha de Emisión</label>
                                    <input type="date" id="fechaEmision" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="fechaTermino" class="block text-sm font-medium text-gray-700 required-field">Fecha de Término</label>
                                    <input type="date" id="fechaTermino" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="condicionPago" class="block text-sm font-medium text-gray-700 required-field">Condición de Pago</label>
                                    <select id="condicionPago" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        <option value="">Seleccione...</option>
                                        <option value="30 días">30 días</option>
                                        <option value="60 días">60 días</option>
                                        <option value="90 días">90 días</option>
                                        <option value="Contado">Contado</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="departamento" class="block text-sm font-medium text-gray-700">Departamento</label>
                                    <input type="text" id="departamento" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="estado" class="block text-sm font-medium text-gray-700 required-field">Estado</label>
                                    <select id="estado" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        <option value="emitida">Emitida</option>
                                        <option value="aprobada">Aprobada</option>
                                        <option value="rechazada">Rechazada</option>
                                        <option value="completada">Completada</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Información del Proveedor -->
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="border-b border-gray-200 px-6 py-4">
                            <h2 class="text-lg font-medium text-gray-800">Información del Proveedor</h2>
                        </div>
                        <div class="px-6 py-4">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <label for="proveedor" class="block text-sm font-medium text-gray-700 required-field">Proveedor</label>
                                    <input type="text" id="proveedor" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="rut" class="block text-sm font-medium text-gray-700 required-field">RUT</label>
                                    <input type="text" id="rut" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="contacto" class="block text-sm font-medium text-gray-700">Contacto</label>
                                    <input type="text" id="contacto" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                                    <input type="email" id="email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="telefono" class="block text-sm font-medium text-gray-700">Teléfono</label>
                                    <input type="text" id="telefono" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="direccion" class="block text-sm font-medium text-gray-700">Dirección</label>
                                    <input type="text" id="direccion" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Detalle de Items -->
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="border-b border-gray-200 px-6 py-4">
                            <h2 class="text-lg font-medium text-gray-800">Detalle de Items</h2>
                        </div>
                        <div class="px-6 py-4">
                            <div id="itemsContainer">
                                <!-- Los items se agregarán dinámicamente aquí -->
                            </div>
                            <button type="button" id="agregarItem" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center space-x-2">
                                <i class="fas fa-plus"></i>
                                <span>Agregar Item</span>
                            </button>
                        </div>
                    </div>

                    <!-- Totales -->
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="border-b border-gray-200 px-6 py-4">
                            <h2 class="text-lg font-medium text-gray-800">Totales</h2>
                        </div>
                        <div class="px-6 py-4">
                            <div class="flex justify-end">
                                <div class="w-64">
                                    <div class="flex justify-between py-2">
                                        <span class="text-sm font-medium text-gray-600">Subtotal:</span>
                                        <div class="flex items-center">
                                            <span class="mr-1">$</span>
                                            <input type="text" id="subtotal" readonly class="w-28 rounded-md border-gray-300 shadow-sm bg-gray-100">
                                        </div>
                                    </div>
                                    <div class="flex justify-between py-2">
                                        <span class="text-sm font-medium text-gray-600">Descuento:</span>
                                        <div class="flex items-center">
                                            <span class="mr-1">$</span>
                                            <input type="text" id="descuento" readonly class="w-28 rounded-md border-gray-300 shadow-sm bg-gray-100">
                                        </div>
                                    </div>
                                    <div class="flex justify-between py-2">
                                        <span class="text-sm font-medium text-gray-600">IVA (19%):</span>
                                        <div class="flex items-center">
                                            <span class="mr-1">$</span>
                                            <input type="text" id="iva" readonly class="w-28 rounded-md border-gray-300 shadow-sm bg-gray-100">
                                        </div>
                                    </div>
                                    <div class="flex justify-between py-2 border-t border-gray-200">
                                        <span class="text-base font-bold text-gray-800">Total:</span>
                                        <div class="flex items-center">
                                            <span class="mr-1">$</span>
                                            <input type="text" id="total" readonly class="w-28 rounded-md border-gray-300 shadow-sm bg-gray-100">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between">
                        <button type="button" id="btnVolver" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 flex items-center space-x-2">
                            <i class="fas fa-arrow-left"></i>
                            <span>Volver</span>
                        </button>
                        <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 flex items-center space-x-2">
                            <i class="fas fa-save"></i>
                            <span>Guardar Cambios</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Template para items -->
    <template id="itemTemplate">
        <div class="item-row" data-item-id="{itemId}">
            <div class="flex justify-between items-start mb-4">
                <span class="px-3 py-1 bg-blue-600 text-white rounded-full text-sm item-number">1</span>
                <button type="button" class="text-red-500 hover:text-red-700 eliminar-item">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="itemNombre{itemId}" class="block text-sm font-medium text-gray-700">Nombre</label>
                    <input type="text" id="itemNombre{itemId}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 item-nombre" placeholder="Nombre del ítem">
                </div>
                <div>
                    <label for="itemDescripcion{itemId}" class="block text-sm font-medium text-gray-700 required-field">Descripción</label>
                    <input type="text" id="itemDescripcion{itemId}" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 item-descripcion" placeholder="Descripción detallada">
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div>
                    <label for="itemCeco{itemId}" class="block text-sm font-medium text-gray-700">CECO</label>
                    <input type="text" id="itemCeco{itemId}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 item-ceco" placeholder="Código CECO">
                </div>
                <div>
                    <label for="itemCantidad{itemId}" class="block text-sm font-medium text-gray-700 required-field">Cantidad</label>
                    <input type="number" id="itemCantidad{itemId}" required step="0.01" min="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 item-cantidad">
                </div>
                <div>
                    <label for="itemUnidad{itemId}" class="block text-sm font-medium text-gray-700 required-field">Unidad</label>
                    <select id="itemUnidad{itemId}" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 item-unidad">
                        <option value="">Seleccionar...</option>
                        <option value="unidad">Unidad</option>
                        <option value="metro">Metro</option>
                        <option value="m2">Metro cuadrado</option>
                        <option value="m3">Metro cúbico</option>
                        <option value="kg">Kilogramo</option>
                        <option value="ton">Tonelada</option>
                        <option value="litro">Litro</option>
                        <option value="par">Par</option>
                        <option value="caja">Caja</option>
                        <option value="rollo">Rollo</option>
                        <option value="paquete">Paquete</option>
                        <option value="servicio">Servicio</option>
                        <option value="hora">Hora</option>
                        <option value="dia">Día</option>
                    </select>
                </div>
                <div>
                    <label for="itemPrecio{itemId}" class="block text-sm font-medium text-gray-700 required-field">Precio</label>
                    <div class="mt-1 flex rounded-md shadow-sm">
                        <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500">$</span>
                        <input type="number" id="itemPrecio{itemId}" required step="1" min="0" class="block w-full rounded-none rounded-r-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 item-precio">
                    </div>
                </div>
                <div>
                    <label for="itemDescuento{itemId}" class="block text-sm font-medium text-gray-700">Descuento</label>
                    <div class="mt-1 flex rounded-md shadow-sm">
                        <input type="number" id="itemDescuento{itemId}" step="0.01" min="0" max="100" value="0" class="block w-full rounded-none rounded-l-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 item-descuento">
                        <span class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500">%</span>
                    </div>
                </div>
                <div class="md:col-span-5">
                    <label for="itemTotal{itemId}" class="block text-sm font-medium text-gray-700">Total</label>
                    <div class="mt-1 flex rounded-md shadow-sm">
                        <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500">$</span>
                        <input type="text" id="itemTotal{itemId}" readonly class="block w-full rounded-none rounded-r-md border-gray-300 bg-gray-100 focus:border-blue-500 focus:ring-blue-500 item-total">
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script>
        // Variables globales
        let nextItemId = 1;
        let ordenId = null;
        let userData = {};

        document.addEventListener('DOMContentLoaded', function() {
            // Verificar autenticación
            userData = JSON.parse(sessionStorage.getItem('userData') || '{}');
            if (!userData.username) {
                window.location.href = 'login.html';
                return;
            }

            // Actualizar nombre de usuario
            document.getElementById('userName').textContent = userData.username;

            // Obtener el ID de la orden de la URL
            const urlParams = new URLSearchParams(window.location.search);
            ordenId = urlParams.get('id');
            if (!ordenId) {
                window.location.href = 'ordenes-compra.html';
                return;
            }

            // Cargar la orden
            cargarOrden(ordenId);

            // Event listeners
            document.getElementById('agregarItem').addEventListener('click', agregarItem);
            document.getElementById('ordenCompraForm').addEventListener('submit', guardarCambios);
            document.getElementById('btnVolver').addEventListener('click', function() {
                window.location.href = 'ordenes-compra.html';
            });
            document.getElementById('cerrarSesion').addEventListener('click', function() {
                sessionStorage.removeItem('userData');
                window.location.href = 'login.html';
            });

            // Event delegation para eliminar ítems
            document.getElementById('itemsContainer').addEventListener('click', function(e) {
                if (e.target.classList.contains('eliminar-item') || e.target.parentElement.classList.contains('eliminar-item')) {
                    const button = e.target.classList.contains('eliminar-item') ? e.target : e.target.parentElement;
                    const itemRow = button.closest('.item-row');
                    eliminarItem(itemRow);
                }
            });

            // Event delegation para calcular totales cuando se modifican valores
            document.getElementById('itemsContainer').addEventListener('input', function(e) {
                const target = e.target;
                if (target.classList.contains('item-cantidad') || 
                    target.classList.contains('item-precio') || 
                    target.classList.contains('item-descuento')) {
                    const itemRow = target.closest('.item-row');
                    calcularTotalItem(itemRow);
                    calcularTotales();
                }
            });
        });

        async function cargarOrden(id) {
            try {
                console.log('Cargando orden con ID:', id);
                const response = await fetch(`/api/documentos/${id}`);
                if (!response.ok) {
                    throw new Error('Error al cargar la orden de compra');
                }

                const orden = await response.json();
                console.log('Orden cargada:', orden);

                // Llenar información general
                document.getElementById('numeroOC').value = orden.numero;
                document.getElementById('fechaEmision').value = orden.fecha ? orden.fecha.split('T')[0] : '';
                document.getElementById('fechaTermino').value = orden.fecha_termino ? orden.fecha_termino.split('T')[0] : '';
                document.getElementById('condicionPago').value = orden.condicion_pago || '';
                document.getElementById('departamento').value = orden.departamento || '';
                document.getElementById('estado').value = orden.estado || 'emitida';

                // Llenar información del proveedor
                document.getElementById('proveedor').value = orden.proveedor || '';
                document.getElementById('rut').value = orden.rut || '';
                document.getElementById('contacto').value = orden.contacto || '';
                document.getElementById('email').value = orden.email || '';
                document.getElementById('telefono').value = orden.telefono || '';
                document.getElementById('direccion').value = orden.direccion || '';

                // Llenar items
                const itemsContainer = document.getElementById('itemsContainer');
                itemsContainer.innerHTML = '';

                if (orden.items && orden.items.length > 0) {
                    console.log('Cargando items:', orden.items.length);
                    orden.items.forEach(item => {
                        agregarItem(null, item);
                    });
                } else {
                    console.log('No hay items, agregando uno por defecto');
                    // Si no hay items, agregar uno por defecto
                    agregarItem();
                }

                // Calcular totales
                calcularTotales();

            } catch (error) {
                console.error('Error:', error);
                mostrarError('Error al cargar la orden de compra: ' + error.message);
            }
        }

        function agregarItem(e, itemData = null) {
            try {
                console.log('Agregando nuevo item', nextItemId, itemData);
                const itemsContainer = document.getElementById('itemsContainer');
                if (!itemsContainer) {
                    console.error('No se encontró el contenedor de items');
                    return;
                }
                
                const template = document.getElementById('itemTemplate');
                if (!template) {
                    console.error('No se encontró la plantilla de item');
                    return;
                }
                
                const itemHtml = template.innerHTML.replaceAll('{itemId}', nextItemId);
                
                // Crear un elemento div para el nuevo ítem
                const itemDiv = document.createElement('div');
                itemDiv.innerHTML = itemHtml;
                
                // Agregar el elemento al contenedor
                const firstChild = itemDiv.firstElementChild;
                if (!firstChild) {
                    console.error('Error al crear el elemento del item');
                    return;
                }
                
                itemsContainer.appendChild(firstChild);
                
                // Obtener el nuevo elemento agregado
                const newItemRow = itemsContainer.lastElementChild;
                
                // Si hay datos del item, llenar los campos
                if (itemData) {
                    const nombreInput = newItemRow.querySelector('.item-nombre');
                    if (nombreInput) nombreInput.value = itemData.nombre || '';
                    
                    const descripcionInput = newItemRow.querySelector('.item-descripcion');
                    if (descripcionInput) descripcionInput.value = itemData.descripcion || '';
                    
                    const cecoInput = newItemRow.querySelector('.item-ceco');
                    if (cecoInput) cecoInput.value = itemData.ceco || '';
                    
                    const cantidadInput = newItemRow.querySelector('.item-cantidad');
                    if (cantidadInput) cantidadInput.value = itemData.cantidad || 0;
                    
                    const unidadSelect = newItemRow.querySelector('.item-unidad');
                    if (unidadSelect) unidadSelect.value = itemData.unidad || '';
                    
                    const precioInput = newItemRow.querySelector('.item-precio');
                    if (precioInput) precioInput.value = itemData.precio || 0;
                    
                    const descuentoInput = newItemRow.querySelector('.item-descuento');
                    if (descuentoInput) descuentoInput.value = itemData.descuento_porcentaje || 0;
                    
                    // Calcular el total del item
                    calcularTotalItem(newItemRow);
                }
                
                // Incrementar el contador de ID para el siguiente ítem
                nextItemId++;
                
                // Renumerar todos los ítems
                renumerarItems();
                
                // Si se agregó manualmente (no desde datos cargados), calcular los totales
                if (!itemData) {
                    calcularTotales();
                }
            } catch (error) {
                console.error('Error al agregar item:', error);
                mostrarError('Error al agregar item: ' + error.message);
            }
        }

        function eliminarItem(itemRow) {
            try {
                if (!itemRow) {
                    console.error('No se proporcionó una fila de item válida para eliminar');
                    return;
                }
                
                const items = document.querySelectorAll('.item-row');
                if (items.length <= 1) {
                    mostrarError('Debe haber al menos un ítem en la orden');
                    return;
                }
                
                console.log('Eliminando item');
                itemRow.remove();
                
                // Renumerar todos los ítems
                renumerarItems();
                
                // Recalcular totales
                calcularTotales();
            } catch (error) {
                console.error('Error al eliminar item:', error);
                mostrarError('Error al eliminar item: ' + error.message);
            }
        }

        function renumerarItems() {
            try {
                const items = document.querySelectorAll('.item-row');
                console.log(`Renumerando ${items.length} items`);
                
                items.forEach((item, index) => {
                    const itemNumber = item.querySelector('.item-number');
                    if (itemNumber) {
                        itemNumber.textContent = index + 1;
                    }
                });
            } catch (error) {
                console.error('Error al renumerar items:', error);
            }
        }

        function calcularTotalItem(itemRow) {
            try {
                if (!itemRow) {
                    console.error('No se proporcionó una fila de item válida');
                    return;
                }
                
                const cantidadInput = itemRow.querySelector('.item-cantidad');
                const precioInput = itemRow.querySelector('.item-precio');
                const descuentoInput = itemRow.querySelector('.item-descuento');
                const totalInput = itemRow.querySelector('.item-total');
                
                if (!cantidadInput || !precioInput || !descuentoInput || !totalInput) {
                    console.error('Faltan elementos en la fila del item');
                    return;
                }
                
                const cantidad = parseFloat(cantidadInput.value) || 0;
                const precio = parseFloat(precioInput.value) || 0;
                const descuentoPorcentaje = parseFloat(descuentoInput.value) || 0;
                
                const subtotal = cantidad * precio;
                const descuento = subtotal * (descuentoPorcentaje / 100);
                const total = subtotal - descuento;
                
                totalInput.value = formatearNumero(total);
            } catch (error) {
                console.error('Error al calcular total del item:', error);
            }
        }

        function calcularTotales() {
            try {
                let subtotal = 0;
                let descuentoTotal = 0;
                
                // Calcular subtotal y descuento
                const items = document.querySelectorAll('.item-row');
                console.log(`Calculando totales para ${items.length} items`);
                
                items.forEach((item, index) => {
                    try {
                        const cantidadInput = item.querySelector('.item-cantidad');
                        const precioInput = item.querySelector('.item-precio');
                        const descuentoInput = item.querySelector('.item-descuento');
                        
                        if (!cantidadInput || !precioInput || !descuentoInput) {
                            console.warn(`Item #${index + 1}: Faltan elementos en la fila`);
                            return;
                        }
                        
                        const cantidad = parseFloat(cantidadInput.value) || 0;
                        const precio = parseFloat(precioInput.value) || 0;
                        const descuentoPorcentaje = parseFloat(descuentoInput.value) || 0;
                        
                        const itemSubtotal = cantidad * precio;
                        const itemDescuento = itemSubtotal * (descuentoPorcentaje / 100);
                        
                        subtotal += itemSubtotal;
                        descuentoTotal += itemDescuento;
                        
                        console.log(`Item #${index + 1}: Cantidad=${cantidad}, Precio=${precio}, Descuento=${descuentoPorcentaje}%, Subtotal=${itemSubtotal}, Descuento=${itemDescuento}`);
                    } catch (error) {
                        console.error(`Error al procesar item #${index + 1}:`, error);
                    }
                });
                
                // Calcular IVA y total
                const iva = (subtotal - descuentoTotal) * 0.19;
                const total = subtotal - descuentoTotal + iva;
                
                console.log(`Totales: Subtotal=${subtotal}, Descuento=${descuentoTotal}, IVA=${iva}, Total=${total}`);
                
                // Actualizar valores en la interfaz
                const subtotalInput = document.getElementById('subtotal');
                const descuentoInput = document.getElementById('descuento');
                const ivaInput = document.getElementById('iva');
                const totalInput = document.getElementById('total');
                
                if (subtotalInput) subtotalInput.value = formatearNumero(subtotal);
                if (descuentoInput) descuentoInput.value = formatearNumero(descuentoTotal);
                if (ivaInput) ivaInput.value = formatearNumero(iva);
                if (totalInput) totalInput.value = formatearNumero(total);
            } catch (error) {
                console.error('Error al calcular totales:', error);
                mostrarError('Error al calcular totales: ' + error.message);
            }
        }

        async function guardarCambios(e) {
            e.preventDefault();
            
            // Validación básica del formulario
            const form = document.getElementById('ordenCompraForm');
            if (!form.checkValidity()) {
                // Mostrar mensajes de validación del navegador
                form.reportValidity();
                return;
            }
            
            // Obtener información general
            const orden = {
                id: ordenId,
                numero: document.getElementById('numeroOC').value,
                fecha_emision: document.getElementById('fechaEmision').value,
                fecha_termino: document.getElementById('fechaTermino').value,
                condicion_pago: document.getElementById('condicionPago').value,
                departamento: document.getElementById('departamento').value,
                estado: document.getElementById('estado').value,
                proveedor: document.getElementById('proveedor').value,
                rut: document.getElementById('rut').value,
                contacto: document.getElementById('contacto').value,
                email: document.getElementById('email').value,
                telefono: document.getElementById('telefono').value,
                direccion: document.getElementById('direccion').value,
                subtotal: limpiarFormato(document.getElementById('subtotal').value),
                descuento: limpiarFormato(document.getElementById('descuento').value),
                iva: limpiarFormato(document.getElementById('iva').value),
                total: limpiarFormato(document.getElementById('total').value),
                items: []
            };
            
            // Obtener información de los ítems
            document.querySelectorAll('.item-row').forEach((item, index) => {
                const unidadSelect = item.querySelector('.item-unidad');
                
                const itemData = {
                    numero: index + 1,
                    nombre: item.querySelector('.item-nombre').value,
                    descripcion: item.querySelector('.item-descripcion').value,
                    ceco: item.querySelector('.item-ceco').value,
                    unidad: unidadSelect.value,
                    cantidad: parseFloat(item.querySelector('.item-cantidad').value) || 0,
                    precio: parseFloat(item.querySelector('.item-precio').value) || 0,
                    descuento_porcentaje: parseFloat(item.querySelector('.item-descuento').value) || 0,
                    total: limpiarFormato(item.querySelector('.item-total').value)
                };
                
                orden.items.push(itemData);
            });
            
            // Depuración - Mostrar en consola los datos que se envían
            console.log('Datos de la orden a enviar:', orden);
            
            try {
                // Enviar datos a la API
                const response = await fetch(`/api/documentos/${ordenId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Username': userData.username || 'admin' // Agregar el usuario actual en los headers
                    },
                    body: JSON.stringify(orden)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error al actualizar la orden de compra');
                }
                
                const data = await response.json();
                mostrarMensaje('Orden de compra actualizada correctamente', 'success');
                
                // Redireccionar después de un tiempo
                setTimeout(() => {
                    window.location.href = 'ordenes-compra.html';
                }, 1500);
                
            } catch (error) {
                console.error('Error:', error);
                mostrarError('Error al actualizar la orden de compra: ' + error.message);
            }
        }

        function formatearNumero(numero) {
            if (numero === null || numero === undefined || isNaN(numero)) {
                return "0";
            }
            return numero.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        function limpiarFormato(valor) {
            try {
                if (valor === null || valor === undefined) {
                    return 0;
                }
                
                if (typeof valor === 'string') {
                    // Eliminar puntos y reemplazar comas por puntos para el formato decimal
                    return parseFloat(valor.replace(/\./g, '').replace(',', '.')) || 0;
                }
                
                if (typeof valor === 'number') {
                    return valor;
                }
                
                return 0;
            } catch (error) {
                console.error('Error al limpiar formato:', error, 'valor:', valor);
                return 0;
            }
        }

        function mostrarMensaje(mensaje, tipo) {
            try {
                console.log(`Mostrando mensaje (${tipo}): ${mensaje}`);
                
                // Eliminar alertas anteriores
                const alertasAnteriores = document.querySelectorAll('.alerta-mensaje');
                alertasAnteriores.forEach(alerta => alerta.remove());
                
                // Crear nueva alerta
                const alertaDiv = document.createElement('div');
                alertaDiv.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg ${
                    tipo === 'success' ? 'bg-green-600' : 'bg-red-600'
                } text-white flex items-center space-x-2 z-50 alerta-mensaje`;
                
                alertaDiv.innerHTML = `
                    <span>${mensaje || 'Ha ocurrido un error'}</span>
                    <button class="ml-4 close-alert">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                // Agregar la alerta al DOM
                document.body.appendChild(alertaDiv);
                
                // Agregar evento de cierre
                const closeButton = alertaDiv.querySelector('.close-alert');
                if (closeButton) {
                    closeButton.addEventListener('click', () => {
                        alertaDiv.remove();
                    });
                }
                
                // Auto-eliminar después de un tiempo
                setTimeout(() => {
                    if (alertaDiv.parentNode) {
                        alertaDiv.remove();
                    }
                }, 5000);
            } catch (error) {
                console.error('Error al mostrar mensaje:', error);
            }
        }

        function mostrarError(mensaje) {
            mostrarMensaje(mensaje || 'Ha ocurrido un error inesperado', 'error');
        }
    </script>
</body>
</html> 